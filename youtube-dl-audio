#!/bin/sh

if [ -z `which youtube-dl` -o -z `which ffmpeg` -o -z `which ffprobe` ]; then
	echo "Error: Could not find youtube-dl, ffmpeg, or ffprobe" >&2
	exit 1
fi

if [ -z "$1" ]; then
	echo "Error: Please specify an output filename" >&2
	exit 1
fi

if [ -z "$2" ]; then
	echo "Error: Argument 1 must be YouTube link" >&2
	exit 1
fi

TEMP_FILENAME="$1.tmp.flv"

[ -f "$TEMP_FILENAME" ] && SKIP_DL_ARG="--skip-download"

youtube-dl $SKIP_DL_ARG -o "$TEMP_FILENAME" $2

if [ $? -ne 0 ]; then
	echo "Error: youtube-dl failed" >&2
	exit 1
fi

BITRATE=`ffprobe "$TEMP_FILENAME" 2>&1 | grep "Stream #0:1: Audio: " | awk '{print $9}'`
CODEC=`ffprobe "$TEMP_FILENAME" 2>&1 | grep "Stream #0:1: Audio: " | awk '{print $4}' | cut -d, -f1`

#Force the output codec for now
OUTPUT_CODEC=mp3
#OUTPUT_CODEC=copy
case $OUTPUT_CODEC in
	aac)  CONTAINER=aac ;;
	mp3)  CONTAINER=mp3 ;;
	copy) CONTAINER=$CODEC ;;
	*)    CONTAINER=$CODEC ;;
esac
case $OUTPUT_CODEC in
	mp3)  FFMPEG_CODEC=libmp3lame ;;
	copy) FFMPEG_CODEC=copy ;;
esac

OUTPUT_FILENAME="$1.$CONTAINER"

ffmpeg -i "$TEMP_FILENAME" -acodec $FFMPEG_CODEC -ab "$BITRATE"k "$OUTPUT_FILENAME"

if [ $? -eq 0 ]; then
	echo
	echo "=============================================================="
	echo "Filename: $OUTPUT_FILENAME   Codec: $CODEC->$OUTPUT_CODEC   Bitrate: "$BITRATE"k"
	echo "=============================================================="
	echo
	#rm "$TEMP_FILENAME"
else
	echo "Error: ffmpeg didn't extract audio properly, preserving original file: $TEMP_FILENAME" >&2
fi

